<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copilot Router - ç™»å½•</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .step.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .code-box {
      background: #f5f5f5;
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
    }
    .user-code {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      letter-spacing: 4px;
      font-family: monospace;
    }
    .verify-link {
      display: inline-block;
      margin-top: 15px;
      color: #764ba2;
      text-decoration: none;
      font-weight: 500;
    }
    .verify-link:hover { text-decoration: underline; }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .status.waiting {
      background: #fff3cd;
      color: #856404;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .token-list {
      margin-top: 20px;
    }
    .token-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .token-info strong {
      color: #333;
    }
    .token-info small {
      color: #666;
    }
    .btn-delete {
      background: #dc3545;
      padding: 8px 16px;
      font-size: 14px;
      width: auto;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      color: #666;
    }
    .tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: 500;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
    }
    input[type="text"]:focus {
      border-color: #667eea;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Copilot Router</h1>
    <p class="subtitle">GitHub Copilot API ä»£ç†æœåŠ¡</p>

    <div class="tabs">
      <div class="tab active" onclick="showTab('login')">è®¾å¤‡ç ç™»å½•</div>
      <div class="tab" onclick="showTab('direct')">ç›´æ¥æ·»åŠ  Token</div>
      <div class="tab" onclick="showTab('tokens')">ç®¡ç† Tokens</div>
    </div>

    <!-- è®¾å¤‡ç ç™»å½• -->
    <div id="tab-login">
      <div id="step1" class="step active">
        <p style="margin-bottom: 20px;">ä½¿ç”¨ GitHub è®¾å¤‡ç æµç¨‹ç™»å½•ï¼Œæ”¯æŒæ·»åŠ å¤šä¸ªè´¦å·å®ç°è´Ÿè½½å‡è¡¡ã€‚</p>
        <button onclick="startLogin()">å¼€å§‹ç™»å½•</button>
      </div>

      <div id="step2" class="step">
        <div class="code-box">
          <p>è¯·åœ¨ GitHub è¾“å…¥æ­¤éªŒè¯ç ï¼š</p>
          <div class="user-code" id="userCode">----</div>
          <a href="#" id="verifyLink" class="verify-link" target="_blank">
            ç‚¹å‡»è¿™é‡Œæ‰“å¼€ GitHub éªŒè¯é¡µé¢ â†’
          </a>
        </div>
        <div class="status waiting">
          <span class="spinner"></span>
          ç­‰å¾…æˆæƒä¸­... è¯·åœ¨ GitHub å®ŒæˆéªŒè¯
        </div>
      </div>

      <div id="step3" class="step">
        <div class="status success">
          âœ… ç™»å½•æˆåŠŸï¼
        </div>
        <p id="successMessage" style="text-align: center; margin: 20px 0;"></p>
        <button onclick="resetLogin()">æ·»åŠ å¦ä¸€ä¸ªè´¦å·</button>
      </div>

      <div id="stepError" class="step">
        <div class="status error">
          âŒ <span id="errorMessage">ç™»å½•å¤±è´¥</span>
        </div>
        <button onclick="resetLogin()" style="margin-top: 15px;">é‡è¯•</button>
      </div>
    </div>

    <!-- ç›´æ¥æ·»åŠ  Token -->
    <div id="tab-direct" style="display: none;">
      <p style="margin-bottom: 20px;">å¦‚æœä½ å·²ç»æœ‰ GitHub Tokenï¼Œå¯ä»¥ç›´æ¥æ·»åŠ ï¼š</p>
      <input type="text" id="directToken" placeholder="è¾“å…¥ GitHub Token (ghu_xxx æˆ– gho_xxx)">
      <button onclick="addTokenDirect()">æ·»åŠ  Token</button>
      <div id="directResult"></div>
    </div>

    <!-- ç®¡ç† Tokens -->
    <div id="tab-tokens" style="display: none;">
      <button onclick="loadTokens()">åˆ·æ–°åˆ—è¡¨</button>
      <div id="tokenList" class="token-list">
        <p style="color: #666; text-align: center; padding: 20px;">ç‚¹å‡»åˆ·æ–°åŠ è½½ Token åˆ—è¡¨</p>
      </div>
    </div>
  </div>

  <script>
    let deviceCode = null;
    let pollInterval = null;

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tabs .tab').forEach((t, i) => {
        if ((tab === 'login' && i === 0) || (tab === 'direct' && i === 1) || (tab === 'tokens' && i === 2)) {
          t.classList.add('active');
        }
      });
      document.getElementById('tab-login').style.display = tab === 'login' ? 'block' : 'none';
      document.getElementById('tab-direct').style.display = tab === 'direct' ? 'block' : 'none';
      document.getElementById('tab-tokens').style.display = tab === 'tokens' ? 'block' : 'none';
      
      if (tab === 'tokens') loadTokens();
    }

    async function startLogin() {
      try {
        const res = await fetch('/auth/login', { method: 'POST' });
        const data = await res.json();
        
        if (data.error) {
          showError(data.error.message);
          return;
        }

        deviceCode = data;
        document.getElementById('userCode').textContent = data.user_code;
        document.getElementById('verifyLink').href = data.verification_uri;
        
        showStep('step2');
        startPolling();
      } catch (e) {
        showError('æ— æ³•è¿æ¥æœåŠ¡å™¨');
      }
    }

    function startPolling() {
      pollInterval = setInterval(async () => {
        try {
          const res = await fetch('/auth/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              device_code: deviceCode.device_code,
              interval: deviceCode.interval,
              expires_in: deviceCode.expires_in
            })
          });
          const data = await res.json();
          
          // å¤„ç†æ–°çš„å“åº”æ ¼å¼
          if (data.status === 'pending' || data.status === 'processing' || data.status === 'slow_down') {
            // è¿˜åœ¨ç­‰å¾…æˆæƒæˆ–å¤„ç†ä¸­ï¼Œç»§ç»­è½®è¯¢
            return;
          }
          
          if (data.status === 'success') {
            clearInterval(pollInterval);
            pollInterval = null;
            document.getElementById('successMessage').textContent = 
              `å·²æ·»åŠ è´¦å·: ${data.username || 'Unknown'}`;
            showStep('step3');
            return;
          }
          
          if (data.error) {
            clearInterval(pollInterval);
            pollInterval = null;
            showError(data.error.message || 'æˆæƒå¤±è´¥');
            return;
          }
        } catch (e) {
          // ç½‘ç»œé”™è¯¯ï¼Œç»§ç»­è½®è¯¢
          console.error('Polling error:', e);
        }
      }, (deviceCode.interval + 1) * 1000);

      // è¶…æ—¶å¤„ç†
      setTimeout(() => {
        if (pollInterval) {
          clearInterval(pollInterval);
          showError('éªŒè¯è¶…æ—¶ï¼Œè¯·é‡è¯•');
        }
      }, deviceCode.expires_in * 1000);
    }

    async function addTokenDirect() {
      const token = document.getElementById('directToken').value.trim();
      if (!token) {
        document.getElementById('directResult').innerHTML = 
          '<div class="status error" style="margin-top:15px">è¯·è¾“å…¥ Token</div>';
        return;
      }

      try {
        const res = await fetch('/auth/tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ github_token: token })
        });
        const data = await res.json();
        
        if (data.error) {
          document.getElementById('directResult').innerHTML = 
            `<div class="status error" style="margin-top:15px">${data.error.message}</div>`;
        } else {
          document.getElementById('directResult').innerHTML = 
            `<div class="status success" style="margin-top:15px">âœ… æ·»åŠ æˆåŠŸ: ${data.username}</div>`;
          document.getElementById('directToken').value = '';
        }
      } catch (e) {
        document.getElementById('directResult').innerHTML = 
          '<div class="status error" style="margin-top:15px">æ·»åŠ å¤±è´¥</div>';
      }
    }

    async function loadTokens() {
      try {
        const res = await fetch('/auth/tokens');
        const data = await res.json();
        
        if (!data.tokens || data.tokens.length === 0) {
          document.getElementById('tokenList').innerHTML = 
            '<p style="color: #666; text-align: center; padding: 20px;">æš‚æ—  Tokenï¼Œè¯·å…ˆç™»å½•æ·»åŠ </p>';
          return;
        }

        let html = `<p style="margin-bottom:15px">å…± ${data.total} ä¸ª Tokenï¼Œ${data.active} ä¸ªæ´»è·ƒ</p>`;
        for (const t of data.tokens) {
          html += `
            <div class="token-item">
              <div class="token-info">
                <strong>${t.username || 'Unknown'}</strong><br>
                <small>ID: ${t.id} | ${t.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ åœç”¨'} | è¯·æ±‚: ${t.request_count}</small>
              </div>
              <button class="btn-delete" onclick="deleteToken(${t.id})">åˆ é™¤</button>
            </div>
          `;
        }
        document.getElementById('tokenList').innerHTML = html;
      } catch (e) {
        document.getElementById('tokenList').innerHTML = 
          '<p style="color: red; text-align: center; padding: 20px;">åŠ è½½å¤±è´¥</p>';
      }
    }

    async function deleteToken(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Token å—ï¼Ÿ')) return;
      
      try {
        await fetch(`/auth/tokens/${id}`, { method: 'DELETE' });
        loadTokens();
      } catch (e) {
        alert('åˆ é™¤å¤±è´¥');
      }
    }

    function showStep(stepId) {
      document.querySelectorAll('#tab-login .step').forEach(s => s.classList.remove('active'));
      document.getElementById(stepId).classList.add('active');
    }

    function showError(message) {
      if (pollInterval) clearInterval(pollInterval);
      document.getElementById('errorMessage').textContent = message;
      showStep('stepError');
    }

    function resetLogin() {
      if (pollInterval) clearInterval(pollInterval);
      deviceCode = null;
      showStep('step1');
    }
  </script>
</body>
</html>
